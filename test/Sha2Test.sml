
structure Sha2Test =
struct
  open SMLUnit
  open Assert
  val ($,%,&,?) = let open Test in (TestLabel, TestCase, TestList, assert) end

  structure CAVP = CAVPParser

  local
    val ` = valOf o Sha224.fromHexString
    val hash = Sha224.hashString
    val assert = assertEqual op= Sha224.toString
  in
    fun test_sha224 () =
      $("test_sha224",
        &[ %(fn()=> assert (`"23097D223405D8228642A477BDA255B32AADBCE4BDA0B3F7E36C9DA7")
                           (hash "abc"))
         , %(fn()=> assert (`"75388B16512776CC5DBA5DA1FD890150B0C6455CB4F58B1952522525")
                           (hash "abcdbcdecdefdefgefghfghighijhijkijkljklmklmnlmnomnopnopq"))
        ])
  end

  local
    open Sha256
    val ` = valOf o fromHexString
    val hash = hashString
    val assert = assertEqual op= toString
    infix ==> =-=>
    fun input ==> exp = %(fn()=> assert (` exp) (hashString input))
    fun input =-=> exp = %(fn()=> assert (` exp) (hashVector input))
    fun repeat 0 _ = []
      | repeat n x = x::repeat (n-1) x
  in
    fun test_sha256 () =
      $("test_sha256",
        &[ "abc"   ==> "BA7816BF8F01CFEA414140DE5DAE2223B00361A396177A9CB410FF61F20015AD"
         , "abcdbcdecdefdefgefghfghighijhijkijkljklmklmnlmnomnopnopq"
                   ==> "248D6A61D20638B8E5C026930C3E6039A33CE45964FF2167F6ECEDD419DB06C1"
        ])

    fun test_nessie_256 () =
      $("test_nessie_256", &[
        $("set1",
          &[ ""    ==> "E3B0C44298FC1C149AFBF4C8996FB92427AE41E4649B934CA495991B7852B855"
           , "a"   ==> "CA978112CA1BBDCAFAC231B39A23DC4DA786EFF8147C4E72B9807785AFEE48BB"
           , "abc" ==> "BA7816BF8F01CFEA414140DE5DAE2223B00361A396177A9CB410FF61F20015AD"
           , "message digest"
                   ==> "F7846F55CF23E14EEBEAB5B4E1550CAD5B509E3348FBC4EFA3A1413D393CB650"
           , "abcdefghijklmnopqrstuvwxyz"
                   ==> "71C480DF93D6AE2F1EFAD1447C66C9525E316218CF51FC8D9ED832F2DAF18B73"
           , "abcdbcdecdefdefgefghfghighijhijkijkljklmklmnlmnomnopnopq"
                   ==> "248D6A61D20638B8E5C026930C3E6039A33CE45964FF2167F6ECEDD419DB06C1"
           , "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
                   ==> "DB4BFCBD4DA0CD85A60C3C37D3FBD8805C77F15FC6B1FDFE614EE0A7C8FDB4C0"
           , concat (repeat 8 "1234567890")
                   ==> "F371BC4A311F2B009EEF952DD83CA80E2B60026C8E935592D0F9C308453C813E"
           , concat (repeat 1000000 "a")
                   ==> "CDC76E5C9914FB9281A1C7E284D73E67F1809A48A497200E046D39CCC7112CD0"
          ]),
        $("set2",
          &[  (* set2 *)
          ]),
        $("set3",
          let fun tuck0 n v = vector (repeat n 0w0 @ v :: repeat (64-n-1) 0w0) in
          &[ (tuck0 0 0wx80) =-=> "A9E8913B13864096B9EA592F9548C87654AAF8DF24E3437645FAC174D1036E1C"
           , (tuck0 0 0wx40) =-=> "F315F3F6D33215F8777A7D5A4B809F433729D13A86FE6ADF3DA5C11137E18273"
           , (tuck0 0 0wx20) =-=> "AE1F446791358EEB17DEBD264614CAEB7F72558C085C73BE0DDE284B4C63A957"
           , (tuck0 0 0wx10) =-=> "94C41AF484FFF7964969E0BDD922F82DFF0F4BE87A60D0664CC9D1FFD3ACD650"
           , (tuck0 0 0wx08) =-=> "2763D88A93549AF57C701D5187E8B477D9AA99EBEFE6D1E41A3CE07BF1A1AA50"
           , (tuck0 0 0wx04) =-=> "D6E497B816C27A31ACD5D9F3ED670639FEF7842FEE51F044DFBFB6319C760A5F"
           , (tuck0 0 0wx02) =-=> "8A023A9E4AFFBB255A6B48AE85CC4A7D1A1B9E8E6809FE9E48535C01C1FC071A"
           , (tuck0 0 0wx01) =-=> "16ABAB341FB7F370E27E4DADCF81766DD0DFD0AE64469477BB2CF6614938B2AF"
           , (tuck0 1 0wx80) =-=> "5A42062C0EF5A54ECCF7B0B155C90BBF408AB2480EE939342ACBEBC24E265401"
           , (tuck0 1 0wx40) =-=> "B5B17E5DFF8C9A4AE35D22DE243821159C400060F0F32D8FD87914DA904AE459"
           , (tuck0 1 0wx20) =-=> "5CD77BAB00B0CDF152F3B0B42287F061E5DAF3AC7806B484572DB8E0A64BEE77"
           , (tuck0 1 0wx10) =-=> "ED5F4ED0D6617D50ABD49D4C84281E175B48A7E1EDF550A89BF2C9B5C4CE01F0"
           , (tuck0 1 0wx08) =-=> "D5755A80F47671E9C3E10C007865D7868432D9942CA2CE7D60510039A281CC5C"
           , (tuck0 1 0wx04) =-=> "335D953107E146619C0BF52F8D650C2CDBB5DAF1E1278F51437D96215AC74DB9"
           , (tuck0 1 0wx02) =-=> "1A2A07EA5731313C488CD126D0C118542516CF35A507F9E8AE4A81EA92E3F267"
           , (tuck0 1 0wx01) =-=> "4286DA436D65E3A216846042CA5E0F51AC7A192E9DA271A72A9C4097BEECD52F"
           , (tuck0 2 0wx80) =-=> "FE882C6CF31C7A4A93A4F5A2BC5499E443731A87F6074EB32CEFAFA3E3B8B864"
           , (tuck0 2 0wx40) =-=> "5B9CD7FE975B5F7894DF930EB23518029068F9BA7D2DAD3D8DA29B40E1AA2EF0"
           , (tuck0 2 0wx20) =-=> "36558C5A404A9748423F31D60FAD2373E643A9B5B2F145C4390AD8C80345DC14"
           , (tuck0 2 0wx10) =-=> "887BBFD20CB15B19D2483B1D56DFCF5BCD74B8D05ED44CC912ABE80E92D1064F"
           , (tuck0 2 0wx08) =-=> "5D434409283CDC8E500C72DE5591F50BD858C8377A7F5F979E5F1B446E091EC0"
           , (tuck0 2 0wx04) =-=> "68062FA9A8B16191F44B782CBC5C35E434965C23E7922001447B2005F5EAB033"
           , (tuck0 2 0wx02) =-=> "CFA4AAF2F726AD6D9726B59E8D850BA58B688490E5214187B1766963E0DC1408"
           , (tuck0 2 0wx01) =-=> "2F59C313EECC21D0CAE49D92EF60246E0498BCB84FF30925F2E9BC045578B1AA"
           , (tuck0 3 0wx80) =-=> "2E7963AF3EC7FF5CE6A4C23FF2C3D9BFA765C1A7CCF843E03E0BE147D852E91D"
           , (tuck0 3 0wx40) =-=> "2FF775793E4DCBAD7D20D2428BC09CEEC908628797AEFD57A958B50F3485FEA3"
           , (tuck0 3 0wx20) =-=> "3DAE0491CDE03D6C7FAEA715170ED25139A0F7B77F601FA20F2A6FBAF8076610"
           , (tuck0 3 0wx10) =-=> "63635B0197FC6C31478B85C92748372B03C4356718B5D600B677C2F7A2A45DF9"
           , (tuck0 3 0wx08) =-=> "C4F689A854EFE7254FE0683DFC3ED392BB5F98656B2B906437819416F43D190C"
           , (tuck0 3 0wx04) =-=> "F0E43B2C47EE3CF4865CAFA6C2406CADEF4C7AE461AA7FD23C9F294F88AC3E23"
           , (tuck0 3 0wx02) =-=> "C4A8240D8711FF7C881B00324B9FB0A8BE9D90D99E7F95525EA69EAF9F7658CB"
           , (tuck0 3 0wx01) =-=> "18AE4CCBDA9538839D79BB18CA09E23E24AE8C1550F56CBB3D84B05331FFF401"
           , (tuck0 4 0wx80) =-=> "1B19FF19DB12ED9ACC13FA3A0AF2359D7F247946306E2B4BB9C33CDAFF3AF619"
           , (tuck0 4 0wx40) =-=> "9FC1D2FDDC3BF79EF1CD260C4DC38F9049FE9008A30361E939FB7D3484B78913"
           , (tuck0 4 0wx20) =-=> "73EC741E9AAB162395254AAA253960753D7B2270648C47BCF88D6B56B4B21B6D"
           , (tuck0 4 0wx10) =-=> "2E65812BD89BD1145EFEB3907772D220902C3D29DDA4DCBD5C56D956DFB3798A"
           , (tuck0 4 0wx08) =-=> "96CBBE51E1657CEA98D8A528B326F9E12B4EC3E96DF44248472E314378E63289"
           , (tuck0 4 0wx04) =-=> "0AB3F00B996C2E9B364C0180CBE26663D0270E7FBD54C6B1161A0E5AECF2730B"
           , (tuck0 4 0wx02) =-=> "78554A3A0C8F62E32DB9906F946B2BB3AC03B88618170E9E67C011EE4F7096D1"
           , (tuck0 4 0wx01) =-=> "D6DAAFE3DFBC6F26CEBBFEF13DBA8216F3CE07972F0755B0A39C92ABF6858E70"
           , (tuck0 5 0wx80) =-=> "55FFE1A582E6C6EC8EB546943833E4B746B122597B0937E265A7E2151F8EC5F1"
           , (tuck0 5 0wx40) =-=> "EC44B4A96BB31BE6E90B95FFAEF0FCB1650DCA2AC3687837FE0454EBCC3CF6E2"
           , (tuck0 5 0wx20) =-=> "E233BA3685C62E92EAE8A6A5E876426D8C384A4F0A41DD769A2EE19156127C2B"
           , (tuck0 5 0wx10) =-=> "C48910BEEC85E2C9E5DD94E15FB8F93FAE049199776832E7001CDC70139B24F5"
           , (tuck0 5 0wx08) =-=> "E810A131AB2FE5C1B224E06FB74237C52CFC290F8BB5E7CA67704ACF26A6A8F4"
           , (tuck0 5 0wx04) =-=> "EB3B3D88EC46D915AF459E38EEBCFE26ECD7FF2D966E99A5760A71001D4DB287"
           , (tuck0 5 0wx02) =-=> "A6444DCE5DEED90C057E9BF7126BF2A7DDA65FEFD19C0C835BB6228D24319EB5"
           , (tuck0 5 0wx01) =-=> "384A41704D44FC9FA013A0EE0A967AC55B303D92782D0DC1B002CE1163422B5B"
          ]
          end)
        ])
  end

  local
    open Sha384
    val ` = valOf o fromHexString
    val hash = hashString
    val assert = assertEqual op= toString
    infix ==> =-=>
    fun input ==> exp = %(fn()=> assert (` exp) (hashString input))
    fun input =-=> exp = %(fn()=> assert (` exp) (hashVector input))
    fun repeat 0 _ = []
      | repeat n x = x::repeat (n-1) x
  in
    fun test_nessie_384 () =
      $("test_nessie_384", &[
        $("set1",
          &[ ""    ==> "38B060A751AC96384CD9327EB1B1E36A21FDB71114BE07434C0CC7BF63F6E1DA274EDEBFE76F65FBD51AD2F14898B95B"
           , "a"   ==> "54A59B9F22B0B80880D8427E548B7C23ABD873486E1F035DCE9CD697E85175033CAA88E6D57BC35EFAE0B5AFD3145F31"
           , "abc" ==> "CB00753F45A35E8BB5A03D699AC65007272C32AB0EDED1631A8B605A43FF5BED8086072BA1E7CC2358BAECA134C825A7"
           , "message digest"
                   ==> "473ED35167EC1F5D8E550368A3DB39BE54639F828868E9454C239FC8B52E3C61DBD0D8B4DE1390C256DCBB5D5FD99CD5"
           , "abcdefghijklmnopqrstuvwxyz"
                   ==> "FEB67349DF3DB6F5924815D6C3DC133F091809213731FE5C7B5F4999E463479FF2877F5F2936FA63BB43784B12F3EBB4"
           , "abcdbcdecdefdefgefghfghighijhijkijkljklmklmnlmnomnopnopq"
                   ==> "3391FDDDFC8DC7393707A65B1B4709397CF8B1D162AF05ABFE8F450DE5F36BC6B0455A8520BC4E6F5FE95B1FE3C8452B"
           , "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
                   ==> "1761336E3F7CBFE51DEB137F026F89E01A448E3B1FAFA64039C1464EE8732F11A5341A6F41E0C202294736ED64DB1A84"
           , "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
                   ==> "B12932B0627D1C060942F5447764155655BD4DA0C9AFA6DD9B9EF53129AF1B8FB0195996D2DE9CA0DF9D821FFEE67026"
           , concat (repeat 1000000 "a")
                   ==> "9D0E1809716474CB086E834E310A4A1CED149E9C00F248527972CEC5704C2A5B07B8B3DC38ECC4EBAE97DDD87F3D8985"
          ]),
        $("set2",
          &[  (* set2 *)
          ]),
        $("set3",
          let fun tuck0 n v = vector (repeat n 0w0 @ v :: repeat (64-n-1) 0w0) in
          &[ (tuck0 0 0wx80) =-=> "0D6789B7F0BDCD9C88F022D6AF5B863F20E2E3C895210FDBB8DD613913F5ABA7ABA6D4A52B3B6B3ED6B61B711DD58EB8"
           , (tuck0 0 0wx40) =-=> "AC3B878B3D021A321E49663FDD146E7B51FDB92CDA54AD4FC98077B078BE8669CA5A22AE13590E951BAFE64C9055A616"
           , (tuck0 0 0wx20) =-=> "04B38810E761F7E2D872F47E94EDF22DA3B4B8DD9877144FE02D4D56386CD8861DEAEFBBE635835093240E7D4C41F776"
           , (tuck0 0 0wx10) =-=> "421A1933D4BF99B124C2016AF52F63C062283D02B4FB85D6D012BBE074AAA4F5FD0EB7D773E6AB237431A4942251730A"
           , (tuck0 0 0wx08) =-=> "966E1E0E68C21BB326269DD49E864969E003F7EA902F2D14B5820C8062E6426C5DCA70A09F5A21FA444FA1AE06206BDA"
           , (tuck0 0 0wx04) =-=> "81EF05BD7244ECC65C5BEF005931670CD77A3742466F21261A278C1EEA9B24724EE009084F751FE362086793FF3319AA"
           , (tuck0 0 0wx02) =-=> "8F47A61C62E23E5E70E00B62D17A510A702AFB402A5BE3C73B23F3A250F39312F35DAFDD92D104F339AECAB9FB807DCC"
           , (tuck0 0 0wx01) =-=> "FDAE5A152415F7D836BD8E5941B61E8B78E062E336E0A629AB416891EDA9C32153C386A14930C5B0EDD55B1290CC781A"
           , (tuck0 1 0wx80) =-=> "9B553DC40BE9E5728347E7BF078498052F6516E96AE25B496ADA2B0BAEF5829AC301C566CDFD193053F74F7A855ECD42"
           , (tuck0 1 0wx40) =-=> "E596A9D7381025092E907787CAA146C289DACC16D496EF9C86D8A754C4B43614A194E9059DD10A3B2C08865DB3BD56AA"
           , (tuck0 1 0wx20) =-=> "F47BEA73D9C332E30F0CBA95296D32ADD27B98402B73512EF8C95A0194DF4007257FB76248FEB3AD3A303A6398A09BFC"
           , (tuck0 1 0wx10) =-=> "931AB6E9C06EE26C32E09BE8C71A5630D54A47FEBDE18A7E40F79B844B164AE2E5F75154E1A6927056C22D3AEA9C813C"
           , (tuck0 1 0wx08) =-=> "FAEC0EA20617F2B5E2182B541131B39335EE482DEF1BB267D702DABFD1A73EBFF355A98E4F7200BB0FF8A1779A23EC64"
           , (tuck0 1 0wx04) =-=> "BA098168973BB02910876D16A93F56899C32AF0975FDDD7138851F28DBC73AA8E63C612704C7BF223DBAB478B855D251"
           , (tuck0 1 0wx02) =-=> "2CBA03C7A570559F0BDC9A2CBE54E2FE5081CD54EEB4CEF09517F9E20EE1D82299A67759627631283C05EEAA166B2228"
           , (tuck0 1 0wx01) =-=> "81C6BCEF2A4753FFB4ADAE459235A65118B38D523FFAA21A7EEDC07CB5A402080E29F0269C262C46AE1CFAC015C0C6C9"
           , (tuck0 2 0wx80) =-=> "7D3B507D162213366B2406174E7E9224EEE3D8D780E19C2AE1C17961377C1C89CA193EEFA3BBCE395BB10BA1E4481F91"
           , (tuck0 2 0wx40) =-=> "75A3B6B5009A6261355115448DAAE1A8D762B6F84C955FEF9784D5B7F29C9CE85FE060A1F91735AFA3C06ADD5758AB70"
           , (tuck0 2 0wx20) =-=> "28A8188AFCD4C8DB7B5A59BA64FFAF76E2AF87A859485DCB1130E957EDA07DD2B90E8DBCC04C47B8DD628D9AA3B1AC36"
           , (tuck0 2 0wx10) =-=> "848F4E21D91046829564C7721818938D13167FD62CD0E16D6E2B67A34754CF246BD76F9F065C5C3F425C5D4D1B9A2B8F"
           , (tuck0 2 0wx08) =-=> "755762D00DC98313BDE28D7632BB6117BAE73B4C1AABA9B2C92C874E7AD555EB17F0C282A5261A957E90C44546D9D89E"
           , (tuck0 2 0wx04) =-=> "4EC45CADD660E353271AD1B0ACFB47E58A52D90F415472C6F46F53A02FA29D2870334A5A1D58182075191E64944607A5"
           , (tuck0 2 0wx02) =-=> "1D8F069796623A1D767F490EDCF13AFBED983AD62919F1017CB7814606CFD02A7C36C6A5DF784A1AEB089584B87E1799"
           , (tuck0 2 0wx01) =-=> "9C94A9708CD824BD6FD11D9B17033911EF092934DB9700251E5B63C657068E096E975F40AACAE9422E9EB37C6A5B311B"
           , (tuck0 3 0wx80) =-=> "277559C7583D129BBB3F9563EE167FE7E1FE0C7C0F475332D235F7CDF493CF9DB453572E3567D27D715C3F5B360B756F"
           , (tuck0 3 0wx40) =-=> "E1C69FE8C65AFD6536003F089CBDB7E736C2533CF7E2BF809622296A1C0BC04E198282A14115E5AC326E3D12E5F071F8"
           , (tuck0 3 0wx20) =-=> "5038F268072FD858E9B20A370AF9EB56CF2E2E19878915CC44D3CA590658564AABD339932D2B42F399F1E5E73FA2C7CA"
           , (tuck0 3 0wx10) =-=> "DF977751F8743AD15EB208F28A5814E34476C1DAAFE3E077469E2DCEADC074F781A58DC8AB4725619E45AB58B07E8AC7"
           , (tuck0 3 0wx08) =-=> "940F4BB4B5A76AFC430D16AF8EF4D901F82ACF4215EC1370EE9072BFD61C53F144ECBE569F30F19663F9C7145ED34311"
           , (tuck0 3 0wx04) =-=> "079A3D16C22946B188ED874181825CA65B6D66430EC781620C9BDD8D98741873699B222AE804B32812CCE37B54720DD3"
           , (tuck0 3 0wx02) =-=> "C13874ACFAC8F296434E8473D1574269F1321B3DCA1AE14738C05B608B08B8E284B853E5B937BCAF0A07F5B4F4B64C19"
           , (tuck0 3 0wx01) =-=> "F6DEA48669AD5848BD25674CFE31D8477C82FBD015445B27126A2DE41BD832750778C113B597AFBB570816DDEFD3A658"
           , (tuck0 4 0wx80) =-=> "C2E503144B97D55901F8FA39451FCC39A69AE0A239E31D91DE9F6E3C663FDF953B65B7A1ADB770B0B9BD1423A0BDE138"
           , (tuck0 4 0wx40) =-=> "FC80751CA610189520F98DDA0E8080292E59EC3A67EB4DF7F9359A7B402D642653B810FC7C9727F7BAD06591A3BE4E45"
           , (tuck0 4 0wx20) =-=> "6CDE81FA29EA6E0998B5DDF8A1E015D72453A85B045AC10C267E1848A68620E84E8C4719D421B887CB1C9605AF637C91"
           , (tuck0 4 0wx10) =-=> "46DF52F2183DA06E131F489F1655DC0A21D40FD7BCD7AC1E6A358F9D857AC66D219AFFC261B3DC9F844ACB88EB8CA5ED"
           , (tuck0 4 0wx08) =-=> "574EB8BEA0E6186518074DB1AA78EB140685FF5D769C2D2111B6865E182EA3EFCD9F672EB79DBDF54DC0FD3C6069165A"
           , (tuck0 4 0wx04) =-=> "94325C32609E1F8EA63D9AD128607809E8129D067013803990CFDBAF410D16047D59E6CEB040710B79765B853555A42B"
           , (tuck0 4 0wx02) =-=> "7DF459B62B0EE0A00AEFB36C0B8F12526AC6F52F4E594769DFE1856447AECBCB1589137F6865DB4CA15BAB365A8C9E09"
           , (tuck0 4 0wx01) =-=> "D0A2200F3957B2BAF2D95DD707E72EDBBD072E4813C47EBF3670939B50EC313021730893966255CCB9771D517F1A1882"
           , (tuck0 5 0wx80) =-=> "D18E103D5024A2944CE24B60495CF697E8EDD6C00DC9353BA9E10B37FD2C15A1B131815545BF4F9CF63371DC549F1D0C"
           , (tuck0 5 0wx40) =-=> "E8ACF0A45AA4978883529D0D210D65193002078AD0FE0F72F29B355DE884F994860CCF8850F66D45C64C38A9374F2C7F"
           , (tuck0 5 0wx20) =-=> "9556F35790A9FC33ACD4AF43EF15036AB5A79D4CFC4FAED8BD4DBD8E122FDD96CF08814EE63879C4A18D146782FA9C3E"
           , (tuck0 5 0wx10) =-=> "D82D2895A2990B340A867E426A1F3A6FF94B2749FACD026CC2E1D108FF391C493DEC1D8DAAA8A2009BF24AB138990584"
           , (tuck0 5 0wx08) =-=> "6201C4943101F4F909D01D316CDE19FC54541BB045F3AE3886208DEC2CFE5E1C2A583EE8533CF781161F656388AE7391"
           , (tuck0 5 0wx04) =-=> "7799C8850857F762EE46D5EAE3FBB7228C838B25A5DF40ECB21E9E78F866E5009176DCFCEB921A86F4CD0DAA77EDA3B4"
           , (tuck0 5 0wx02) =-=> "DFBD42FA460B4F199040B330A16C47FD45FB527612A4A6E4E329D4236E8A4DA1B3BB8B270C6ADD7C364CD2E1CC787E05"
           , (tuck0 5 0wx01) =-=> "09087BC1F3237932F7AC5B12D4CBAD45BC177C76999A7D95F503D57BAD06D0C3FACF95EFDF32534EF40E854FF45B1E85"
          ]
          end)
        ])
  end

  local
    open Sha512
    val ` = valOf o fromHexString
    val hash = hashString
    val assert = assertEqual op= toString
    infix ==> =-=>
    fun input ==> exp = %(fn()=> assert (` exp) (hashString input))
    fun input =-=> exp = %(fn()=> assert (` exp) (hashVector input))
    fun repeat 0 _ = []
      | repeat n x = x::repeat (n-1) x
  in
    fun test_nessie_512 () =
      $("test_nessie_512", &[
        $("set1",
          &[ ""    ==> "CF83E1357EEFB8BDF1542850D66D8007D620E4050B5715DC83F4A921D36CE9CE47D0D13C5D85F2B0FF8318D2877EEC2F63B931BD47417A81A538327AF927DA3E"
           , "a"   ==> "1F40FC92DA241694750979EE6CF582F2D5D7D28E18335DE05ABC54D0560E0F5302860C652BF08D560252AA5E74210546F369FBBBCE8C12CFC7957B2652FE9A75"
           , "abc" ==> "DDAF35A193617ABACC417349AE20413112E6FA4E89A97EA20A9EEEE64B55D39A2192992A274FC1A836BA3C23A3FEEBBD454D4423643CE80E2A9AC94FA54CA49F"
           , "message digest"
                   ==> "107DBF389D9E9F71A3A95F6C055B9251BC5268C2BE16D6C13492EA45B0199F3309E16455AB1E96118E8A905D5597B72038DDB372A89826046DE66687BB420E7C"
           , "abcdefghijklmnopqrstuvwxyz"
                   ==> "4DBFF86CC2CA1BAE1E16468A05CB9881C97F1753BCE3619034898FAA1AABE429955A1BF8EC483D7421FE3C1646613A59ED5441FB0F321389F77F48A879C7B1F1"
           , "abcdbcdecdefdefgefghfghighijhijkijkljklmklmnlmnomnopnopq"
                   ==> "204A8FC6DDA82F0A0CED7BEB8E08A41657C16EF468B228A8279BE331A703C33596FD15C13B1B07F9AA1D3BEA57789CA031AD85C7A71DD70354EC631238CA3445"
           , "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
                   ==> "1E07BE23C26A86EA37EA810C8EC7809352515A970E9253C26F536CFC7A9996C45C8370583E0A78FA4A90041D71A4CEAB7423F19C71B9D5A3E01249F0BEBD5894"
           , concat (repeat 8 "1234567890")
                   ==> "72EC1EF1124A45B047E8B7C75A932195135BB61DE24EC0D1914042246E0AEC3A2354E093D76F3048B456764346900CB130D2A4FD5DD16ABB5E30BCB850DEE843"
           , concat (repeat 1000000 "a")
                   ==> "E718483D0CE769644E2E42C7BC15B4638E1F98B13B2044285632A803AFA973EBDE0FF244877EA60A4CB0432CE577C31BEB009C5C2C49AA2E4EADB217AD8CC09B"
          ]),
        $("set2",
          &[  (* set2 *)
          ]),
        $("set3",
          let fun tuck0 n v = vector (repeat n 0w0 @ v :: repeat (64-n-1) 0w0) in
          &[ (tuck0 0 0wx80) =-=> "5655ABFC8D7999F5A95B943442B6FB92C95187FBDFC245CE31C18A53E9B51A5B05B6B6C21686081AC6F8F2C308B9E9321A32B94C89F73E6FFBA35201B02FB986"
           , (tuck0 0 0wx40) =-=> "42BC8579EDB78B98EDCCD0258D701982EDA188B2C1F1F8109608CFD7235EF87F265EC4323F17433716C0B092AFCB30575CFFF4086F4EDED11EE44CE2ECB5474D"
           , (tuck0 0 0wx20) =-=> "5EC5411C25765EDB2925147F8D8186BBB565B62F67E1414D7DA69320D82747A33D9FEB2838BBF559C93BD42C5900AA921A7CAE294AAE01D2240B6809C80F9795"
           , (tuck0 0 0wx10) =-=> "00F5F5F323776140B2F03997C53DBB8B8CE8E65A06CB23C77B74170AE0C43E842A23E41397D75767D77BDB339C41ADEBC98B817728ED322B70E0DA9FE5AEC843"
           , (tuck0 0 0wx08) =-=> "E6733FCCBF0AADFE888017FE3B2436212F17E14B9E1EBC37FB37AF749F3B790B0A457979F06A7D90AED913C2B05D98E99FB56D329748B89D1E4450F339674F4F"
           , (tuck0 0 0wx04) =-=> "C5D6A596875568541FE92E61E308A38D8B2F0B7BD7FA34C3E49A32A85DFD3BA6552F5269A8EDCDBD46300018E627E09D8E62983E1B899A69B9496811C643F5D7"
           , (tuck0 0 0wx02) =-=> "A4CDA617DFDA4AEAE967B26721EF0525E839B64B9C11EF9E5750925D59E46F89F956392A2BED94FC136586AF97F4D703E5C0B4C678E4AD4C047602DE42337A1B"
           , (tuck0 0 0wx01) =-=> "FE8C073EEEAFABF2F6DF1E6A8DD833FB1356C89ACA150FF8C9FD37FE050073E249EC7D9C329762921D06AB0496C59B331E0A754E2DFE18366BC185885A26917C"
           , (tuck0 1 0wx80) =-=> "D6B10118E80D2EF70B798EE0612695E8BE83694FF03DF99D673A9C8F320FD1DB910482C48CBE2829685617E03B70A831CACBF9D4708B70F5EC44244AC52EDBF8"
           , (tuck0 1 0wx40) =-=> "9CEF1643E18DAB9560B7FBDCEC81BEF22D8EAED1219287E14A6F19B436BEB751E3F52ABBF23694CE62118245A595CF88918B7C7F6D5BB728FDB728C7AB9DFA85"
           , (tuck0 1 0wx20) =-=> "ABC0EEB7411221A9B5D6029DD0A84A3B7F736A7229F85478B23A4816E432BDDE3B14B2DF5AE47FD374AB824DFEDD9BC7B0F0547D64BA847A2727F185D82B2970"
           , (tuck0 1 0wx10) =-=> "BC3787FCD453BA8A6A2F3680633B48A1674F6BB7E06B0AC825ACBF3B5B252B43313B247C73CD09B8D6BE3F7B39FF2550AF9AA94D3E27A84C211F59A2CA87FF08"
           , (tuck0 1 0wx08) =-=> "0CD70245E99F61E326F4CAFDD77E0F7C481487C44445315972804F0E0A57EC1AD3819303B7C13984349F7DA5EE4E9230B849C5595AF7E0538237469F34F92FD2"
           , (tuck0 1 0wx04) =-=> "592934C289ECF5FBD8C0B8C9CADA466B13A07E9AB984EB4811C7C423F8B7C7C9AEB1D96933C20DB220947E43FA40D2F0754286E397A7BDB7AEE97918A6260873"
           , (tuck0 1 0wx02) =-=> "4443368DE2561E0B7F4030557E080066A39147360F7AE8967160B275929644EDA7DB275F2778FEF3AC3EC28060C29171803E0A8D39B0CF65A0CBB18FBCD3986D"
           , (tuck0 1 0wx01) =-=> "8963E44F2213058498D116E114690E241BF39250984FCB4D2FCA692C4FDA26F636ACFE0054A4CEDFA1A40F6442593CBE8E6884AC8D5D0D81A83AB8FB2BD74289"
           , (tuck0 2 0wx80) =-=> "194432B1086B73704F526F7106E6CFD807F715085BC9E6518DCE4036BEF5CE1C53494EE37AFEE8D21577DFE9FAC8535659DB43336FBD842F784C98FD856D3F45"
           , (tuck0 2 0wx40) =-=> "69332268608686EC7228FB03597020D104CAE3EEFF2FFDFF129A7A375DA660D2CB0A0C549861358583C6DD9B7E72FE306873ECA1416B106EE8F5E334B46CF105"
           , (tuck0 2 0wx20) =-=> "24E867E1B0024AA1D0C7323BB833E3C5E9109CC4CDC1AC000148AC18810A1B1F3B7DDC548D003905DC8C707524CFC5DB5177167A6060757578BE969B5A3AADC0"
           , (tuck0 2 0wx10) =-=> "F22BE2E5255BFA586765BB11F3BA6117089439F5B99290780716D783FD68A833785676A8CDFA7E8C465CE41FB861C7CACA06BCF61AD14749586D5874066DFC45"
           , (tuck0 2 0wx08) =-=> "20C9ABAD1627ABE0036E607EA823FB5298FCFB85CD5A6446FC98D7AFA5189634D7D4A9B80707A344CACC9D9A07803A139230F8A75439E2E4A7B0B73781CE1039"
           , (tuck0 2 0wx04) =-=> "635D9888A45B4534495E0185D272B485CC2EFED1EC4260A0CFF84DE8CF0CC1FF06E5A98001172938667335FE2543472793E617DA4AC1C75960FFCE4DA56BD69F"
           , (tuck0 2 0wx02) =-=> "1DEADE855339AF4F4DD676DD127B871964D6D6B9693D38029F56A6FB824DF6FD3AAA3EDABA05B729BDD62BD603E1A1E4C32C24073670C0C72CAF8AD1126D095C"
           , (tuck0 2 0wx01) =-=> "F13C5A443AD5A55ADCC4ABC00F2A508A0D49C163346D434BE5CD63F79B9E4AFCE06D8A2BFBE8A4695ADB0E6884F43E05B494A7EC7ECF1E2EAD3BEA220698D107"
           , (tuck0 3 0wx80) =-=> "1DB013A5FC42EE92FDC4B1C845A7EB01E7177EB7293F9D313929506440CC0DA7743C2D09C271823CB4746FAE46DD51E8D77F5573D8C3766458961648E0D5775C"
           , (tuck0 3 0wx40) =-=> "A55266D73830BFEA4BB8B1B95135E6CC6A66A8DC5B6E984F9D9BB4F480316985936086F7933AB30BA83E5F2634A9FFD3CB452C8A0A7B2B3715D995FA9FCE74B0"
           , (tuck0 3 0wx20) =-=> "31301EEBC89F3E2EE284F04BF425989DA7831C0E547B178961633F825F725E9C0284BB64CAA3D3623CCC6BFBB737DF56B9B7AC754B555DCD5156B4FF0429F3AF"
           , (tuck0 3 0wx10) =-=> "433608282DEE28AE46D61B1941C520B613F4D5366B91E915102A1B41EE75FC84D75AEC43C6CC68BCC7E6C093C44414A2D5E42747FCD1C70DC1AEA3548A6B3B5C"
           , (tuck0 3 0wx08) =-=> "58722A82A78F3DC59ADE9AB4DFFBBF5EB10E8F49920A3C7B06A2591717EA41915425B5877EC857A34F5B53EC9A36AAFC930A4D9D4EA3BC361749A5F3BA6FA9A8"
           , (tuck0 3 0wx04) =-=> "8C324E7E3399AD0F8669FBBAF53516B56E64892FFFD5ED6811D47436512A9F9289D17BE00D9F43C2B96903C91B435CAEF80037DB8C5AEC551D6FD61E4FA4FF0D"
           , (tuck0 3 0wx02) =-=> "B9E916471A2957524B58D5472082693C5F64E86C5C02ECCA2BA1EB02B45A00164059D2D5CBB994F656768920A2C288DCFDE029CF401B560B1D6A5753A0441C39"
           , (tuck0 3 0wx01) =-=> "CE8410C84A93A870FD5B81403A249E089556A2AF0B2C653F195F3AE7FA6C883F7AA2440131758A7273ECB9BE3FF64FB8C1EDCBF9A4A8A1BA6E167D75401A1BC5"
           , (tuck0 4 0wx80) =-=> "BC098731773B0DA621D6A35C618C690FEA84BCFE8E4F86B0B501C44C8F13C6042E724A38F9819B05E06CA9341DB83DC3086C0F0C3C862F5920A956509608485B"
           , (tuck0 4 0wx40) =-=> "46FA6EB4402E7815F8DA0A804C9421ED8BFD4D2E59ADE80CF17F468F5CC7363E6E3BFC7F0F3EC9323F09472916CD258629B3743EE3ADCF4B4F5FD8DD263D2B34"
           , (tuck0 4 0wx20) =-=> "3D043283FD431452CB224777FD0FC906E76088824DA62E0CB1F499E54B0989AE1840ED861102BA68B59D083B752CAA8152FCEEADD814813494721EC844E4EC16"
           , (tuck0 4 0wx10) =-=> "AF369E97A0DC14B668153141DE82EA1AE39F6DE2749EFCE089D306C6B2CAB84188D601210DD3843D879E8E7ED24EA0213702FA622CB0F972BB9FDC48E50DF565"
           , (tuck0 4 0wx08) =-=> "517877D377E43763FB43AACC84E2276842ABEFBCD7EC903A327C3154640A461D6EBA6AA5147BC7E66A9A36196F19E7CFE6D4F9C8E81F07A896B04656F2858D48"
           , (tuck0 4 0wx04) =-=> "D491E34BC9C7DA141AAB286CD807DA593AE6A6864A6953C05E233D564E18D73A851BD02D9969C615C9FC8E2805307A2D6450ED65845052ADB5A6FACDA7DFE67B"
           , (tuck0 4 0wx02) =-=> "4037A8CD2C57CED0F9C7FA1D91919736650AB81BE3236CE17684FABC88E81C643476A26491A9EFBFEEA1C8C78CDAAC851E0383924D5DD5FF537CB384C8670199"
           , (tuck0 4 0wx01) =-=> "6AA5657BD67860E4D151C2F6AEEF87DDA1409FF708010902631A9CABA4BBAF4FBD4822E18A06FF26C586B0FB385A770A4A2643F0010998D89B8FD8812AA907C0"
           , (tuck0 5 0wx80) =-=> "BE9D7E52060D4CE12F3BCD2B727BF91B8FD86F20417079529A93044D5FD51D86D6B427519ED726DE9E70663E35CAB07CDF4DA576B470C9C2EF8886580D5BC9E7"
           , (tuck0 5 0wx40) =-=> "F59F82AB4D7B8A20EAB4878F42E6E0F4D70B7CC74B1AEF8477747BF3184782AD95AD7F4EFE691FA1B2B80C3462DAB427E79827409182DF8BCE82124F2EFFB721"
           , (tuck0 5 0wx20) =-=> "54AC5E35F00B7FEF9470CD01839DDFD2E9418C0C7C39A85FA3768D4DA5525116D62C18BD37428966DE14C7278F80EDF45395FD5723E9ABDFBCCC9A72F96471E5"
           , (tuck0 5 0wx10) =-=> "B91B4550D9A0E98AD3532BC3FACFC8716C59B0114E298143D9FC3AA0EF4DCB0FD48D29C0B134A2281384250C3D94E724412FDBB8EB0B6D181436DA064CB8AE82"
           , (tuck0 5 0wx08) =-=> "D252A80DA8A021D8E4454D76D20A60CBF5D8CDC3D113CC81D2252C4482451F2911B3F1EE328C3FD46D9C19E637539861C60E3DF68AC43F01DF6F3F719B038E03"
           , (tuck0 5 0wx04) =-=> "6A139183DCAF8E19560592E816A534256E68CFD0AA7B23EC5CA25DE41ECA95575C5083A81213172E06A0BBB267D3236EFFDFA209D6577B78EFDA1D32281C2458"
           , (tuck0 5 0wx02) =-=> "C6BB247DF5AB4BF9F75C84584C6232218C806776D79851890D1CE3DD8CF6F8BFD30F41649F55E3E235D631D220A93AF78604CB44E86B1C8C03662716A1B0BE43"
           , (tuck0 5 0wx01) =-=> "4546E1966C6E8BABE90BAAC91893BAC1F7D52115129846470F62EC72AB0FB567FD6BC12BF33A6BDA3D32601B782D7FDF5909FE0B3CA9B7520386C28428DEEC58"
          ]
          end)
        ])
  end

  local
    val ` = valOf o Sha384.fromHexString
    val hash = Sha384.hashString
    val assert = assertEqual op= Sha384.toString
  in
    fun test_sha384 () =
      $("test_sha384",
        &[ %(fn()=> assert (`"CB00753F45A35E8BB5A03D699AC65007272C32AB0EDED1631A8B605A43FF5BED8086072BA1E7CC2358BAECA134C825A7")
                           (hash "abc"))
         , %(fn()=> assert (`"09330C33F71147E83D192FC782CD1B4753111B173B3B05D22FA08086E3B0F712FCC7C71A557E2DB966C3E9FA91746039")
                           (hash "abcdefghbcdefghicdefghijdefghijkefghijklfghijklmghijklmnhijklmnoijklmnopjklmnopqklmnopqrlmnopqrsmnopqrstnopqrstu"))
        ])
  end

  local
    val ` = valOf o Sha512.fromHexString
    val hash = Sha512.hashString
    val assert = assertEqual op= Sha512.toString
  in
    fun test_sha512 () =
      $("test_sha512",
        &[ %(fn()=> assert (`"DDAF35A193617ABACC417349AE20413112E6FA4E89A97EA20A9EEEE64B55D39A2192992A274FC1A836BA3C23A3FEEBBD454D4423643CE80E2A9AC94FA54CA49F")
                           (hash "abc"))
         , %(fn()=> assert (`"8E959B75DAE313DA8CF4F72814FC143F8F7779C6EB9F7FA17299AEADB6889018501D289E4900F7E4331B99DEC4B5433AC7D329EEB6DD26545E96E55B874BE909")
                           (hash "abcdefghbcdefghicdefghijdefghijkefghijklfghijklmghijklmnhijklmnoijklmnopjklmnopqklmnopqrlmnopqrsmnopqrstnopqrstu"))
        ])
  end

  (** https://csrc.nist.gov/projects/cryptographic-standards-and-guidelines/example-values
   *)
  fun test_example_values () =
    $("example_values",
      &[ test_sha224()
       , test_sha256()
       , test_sha384()
       , test_sha512()
      ])

  (**
   * NESSIE test vectors
   * https://www.cosic.esat.kuleuven.be/nessie/testvectors/hash/sha/
   *
   * # Fetch
   * $ base_url=https://www.cosic.esat.kuleuven.be/nessie/testvectors/hash/sha
   * $ for bit in 256 384 512;do
   *     curl -s -O ${base_url}/Sha-2-${bit}.unverified.test-vectors
   *   don
   *)
  fun test_nessie_test_vectors () =
    $("nessie_test_vectors",
      &[ test_nessie_256()
       , test_nessie_384()
       , test_nessie_512()
      ])

  local
    structure SS = Substring
    datatype length = Short | Long
    fun lengthToString Short = "Short"
      | lengthToString Long = "Long"
  in
  fun getWord8 ss =
    let
      val w = SOME(SS.splitAt (ss, 2)) handle Subscript => NONE
    in
      Option.mapPartial
        (fn(w,ws)=> Option.map
                      (fn w=> (w,ws))
                      (Word8.fromString (SS.string w)))
        w
    end

  fun test_cavp_sha224_msg length =
    let
      val assert = assertEqual op= Sha224.toString
      val SOME(cases,[]) =
        CAVP.parse ("test/shabytetestvectors/SHA224"^(lengthToString length)^"Msg.rsp")
    in
      $("cavp_sha224_" ^ lengthToString length ^ "_msg",
        &(map
            (fn (msg,md) =>
               %(fn()=> assert (valOf (Sha224.fromHexString md))
                               (Sha224.hashStream' getWord8 (SS.full msg))))
            cases))
    end
    handle IO.Io {name,function,cause}
        => %(fn()=> fail (name ^ ":" ^ function ^ " " ^ exnMessage cause))

  fun test_cavp_sha256_msg length =
    let
      val assert = assertEqual op= Sha256.toString
      val SOME(cases,[]) =
        CAVP.parse ("test/shabytetestvectors/SHA256"^(lengthToString length)^"Msg.rsp")
    in
      $("cavp_sha256_" ^ lengthToString length ^ "_msg",
        &(map
            (fn (msg,md) =>
               %(fn()=> assert (valOf (Sha256.fromHexString md))
                               (Sha256.hashStream' getWord8 (SS.full msg))))
            cases))
    end
    handle IO.Io {name,function,cause}
        => %(fn()=> fail (name ^ ":" ^ function ^ " " ^ exnMessage cause))

  fun test_cavp_sha384_msg length =
    let
      val assert = assertEqual op= Sha384.toString
      val SOME(cases,[]) =
        CAVP.parse ("test/shabytetestvectors/SHA384"^(lengthToString length)^"Msg.rsp")
    in
      $("cavp_sha384_" ^ lengthToString length ^ "_msg",
        &(map
            (fn (msg,md) =>
               %(fn()=> assert (valOf (Sha384.fromHexString md))
                               (Sha384.hashStream' getWord8 (SS.full msg))))
            cases))
    end
    handle IO.Io {name,function,cause}
        => %(fn()=> fail (name ^ ":" ^ function ^ " " ^ exnMessage cause))

  fun test_cavp_sha512_msg length =
    let
      val assert = assertEqual op= Sha512.toString
      val SOME(cases,[]) =
        CAVP.parse ("test/shabytetestvectors/SHA512"^(lengthToString length)^"Msg.rsp")
    in
      $("cavp_sha512_" ^ lengthToString length ^ "_msg",
        &(map
            (fn (msg,md) =>
               %(fn()=> assert (valOf (Sha512.fromHexString md))
                               (Sha512.hashStream' getWord8 (SS.full msg))))
            cases))
    end
    handle IO.Io {name,function,cause}
        => %(fn()=> fail (name ^ ":" ^ function ^ " " ^ exnMessage cause))

  fun test_cavp_sha224 () =
    $("cavp_sha224",
      &[ test_cavp_sha224_msg Short
       , test_cavp_sha224_msg Long
      ])

  fun test_cavp_sha256 () =
    $("cavp_sha256",
      &[ test_cavp_sha256_msg Short
       , test_cavp_sha256_msg Long
      ])

  fun test_cavp_sha384 () =
    $("cavp_sha384",
      &[ test_cavp_sha384_msg Short
       , test_cavp_sha384_msg Long
      ])

  fun test_cavp_sha512 () =
    $("cavp_sha512",
      &[ test_cavp_sha512_msg Short
       , test_cavp_sha512_msg Long
      ])

  end (* local *)

  (** https://csrc.nist.gov/projects/cryptographic-algorithm-validation-program
   * test vectors from Secure Hash Standard Validation System (SHAVS)
   *
   * # Fetch
   * $ curl -L -O https://csrc.nist.gov/CSRC/media/Projects/Cryptographic-Algorithm-Validation-Program/documents/shs/shabytetestvectors.zip
   * $ unzip shabytetestvectors.zip
   *)
  fun test_cavp_test_vectors () =
    $("cavp_test_vectors",
      &[ test_cavp_sha224 ()
       , test_cavp_sha256 ()
       , test_cavp_sha384 ()
       , test_cavp_sha512 ()
      ])

  fun test () =
    $("test",
      &[ test_example_values()
       , test_nessie_test_vectors()
       , test_cavp_test_vectors()
      ])

  fun main (_, _) =
    (TextUITestRunner.runTest {output=TextIO.stdOut} (test());
     TextIO.flushOut TextIO.stdOut;
     OS.Process.success
     )

  fun main' () =
    ignore (main (CommandLine.name(), CommandLine.arguments()))

end
